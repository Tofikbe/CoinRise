<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CoinRise - Ultimate Crypto Exchange</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.0/dist/chartjs-chart-financial.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0e17 0%, #1a2332 100%);
            color: #ffffff;
            min-height: 100vh;
            line-height: 1.6;
        }

        header {
            background: #1a2332;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header h1 {
            font-size: 26px;
            background: linear-gradient(to right, #00c4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        nav {
            background: #1f2a44;
            padding: 10px 0;
            display: flex;
            justify-content: center;
            gap: 25px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        nav button {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 16px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        nav button:hover {
            color: #00c4ff;
            transform: translateY(-2px);
        }

        nav button.active {
            color: #00c4ff;
            border-bottom: 2px solid #00c4ff;
            font-weight: bold;
        }

        .page {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-in;
        }

        .show {
            display: block;
        }

        .token-card {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            background: #1f2a44;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .token-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .token-list {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 0;
            background: #1f2a44;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .token-list button {
            background: #2c3a57;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .token-list button.active {
            background: #00c4ff;
            color: #000;
        }

        .token-list button:hover {
            background: #00a1d6;
        }

        .buy-sell {
            background: #1f2a44;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #00c4ff;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        button:hover {
            background: #00a1d6;
        }

        input, select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #2c3a57;
            color: #fff;
            width: 100%;
            margin: 10px 0;
            font-size: 16px;
        }

        .chart-container {
            background: #1f2a44;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .order-book {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .order-book table {
            width: 100%;
            border-collapse: collapse;
        }

        .order-book th, .order-book td {
            padding: 8px;
            text-align: right;
        }

        .order-book .buy {
            color: #00ff88;
        }

        .order-book .sell {
            color: #ff4d4d;
        }

        .success {
            color: #00ff88;
            font-size: 14px;
            margin-top: 10px;
            animation: fadeIn 0.5s ease-in;
        }

        .error {
            color: #ff4d4d;
            font-size: 14px;
            margin-top: 10px;
            animation: fadeIn 0.5s ease-in;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1f2a44;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
        }

        .transaction-history {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            background: #1f2a44;
            padding: 15px;
            border-radius: 8px;
        }

        .transaction-item {
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        .timeframe-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .timeframe-selector button {
            background: #2c3a57;
        }

        .timeframe-selector button.active {
            background: #00c4ff;
            color: #000;
        }

        .market-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 10px 0;
        }

        .market-stats div {
            background: #1f2a44;
            padding: 10px;
            border-radius: 6px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                align-items: center;
            }

            .buy-sell, .order-book, .market-stats {
                grid-template-columns: 1fr;
            }

            .token-card {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .token-list {
                flex-wrap: nowrap;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>CoinRise - Ultimate Crypto Exchange</h1>
        <div class="user-status">
            <span id="user-status"></span>
            <button onclick="logout()">Logout</button>
        </div>
    </header>
    <nav>
        <button onclick="showPage('dashboard')" id="nav-dashboard" class="active">Dashboard</button>
        <button onclick="showPage('market')" id="nav-market">Market</button>
        <button onclick="showPage('trade')" id="nav-trade">Trade</button>
        <button onclick="showPage('assets')" id="nav-assets">Assets</button>
        <button onclick="showPage('wallet')" id="nav-wallet">Wallet</button>
        <button onclick="showPage('profile')" id="nav-profile">Profile</button>
        <button onclick="showPage('settings')" id="nav-settings">Settings</button>
    </nav>

    <!-- Login Page -->
    <div id="login" class="page show">
        <h2>Login / Signup</h2>
        <input id="username" placeholder="Username (3-20 characters)" required />
        <input id="password" type="password" placeholder="Password (min 8 characters)" required />
        <input id="email" type="email" placeholder="Email" required />
        <button onclick="signup()">Signup</button>
        <button onclick="login()">Login</button>
        <div id="login-msg"></div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page">
        <h2>Dashboard</h2>
        <div class="chart-container">
            <canvas id="market-overview-chart"></canvas>
        </div>
        <div id="portfolio-summary"></div>
        <div id="market-news"></div>
    </div>

    <!-- Market Page -->
    <div id="market" class="page">
        <h2>Market Overview</h2>
        <div id="token-list"></div>
    </div>

    <!-- Trade Page -->
    <div id="trade" class="page">
        <h2>Trade Center</h2>
        <div class="token-list" id="token-list-nav"></div>
        <div class="market-stats" id="market-stats"></div>
        <div class="timeframe-selector">
            <button onclick="setTimeframe('1m')" id="tf-1m">1m</button>
            <button onclick="setTimeframe('5m')" id="tf-5m">5m</button>
            <button onclick="setTimeframe('15m')" id="tf-15m">15m</button>
            <button onclick="setTimeframe('1h')" id="tf-1h" class="active">1h</button>
        </div>
        <div class="chart-container">
            <canvas id="price-chart"></canvas>
        </div>
        <div class="buy-sell">
            <div>
                <h3>Buy</h3>
                <input id="buy-amount" type="number" placeholder="Amount ($KUSD)" min="0" step="0.01" />
                <select id="buy-type">
                    <option value="market">Market Order</option>
                    <option value="limit">Limit Order</option>
                </select>
                <input id="buy-limit-price" type="number" placeholder="Limit Price ($KUSD)" min="0" step="0.01" />
                <button onclick="buyToken()">Buy</button>
            </div>
            <div>
                <h3>Sell</h3>
                <input id="sell-amount" type="number" placeholder="Amount ($KUSD)" min="0" step="0.01" />
                <select id="sell-type">
                    <option value="market">Market Order</option>
                    <option value="limit">Limit Order</option>
                </select>
                <input id="sell-limit-price" type="number" placeholder="Limit Price ($KUSD)" min="0" step="0.01" />
                <button onclick="sellToken()">Sell</button>
            </div>
            <div id="trade-msg"></div>
        </div>
        <div class="order-book">
            <div>
                <h3>Buy Orders</h3>
                <table id="buy-orders"></table>
            </div>
            <div>
                <h3>Sell Orders</h3>
                <table id="sell-orders"></table>
            </div>
        </div>
        <div class="transaction-history" id="transaction-history"></div>
    </div>

    <!-- Assets Page -->
    <div id="assets" class="page">
        <h2>My Portfolio</h2>
        <div id="balance"></div>
        <div id="kusd-balance"></div>
        <div id="portfolio-value"></div>
        <div id="holdings"></div>
        <div class="chart-container">
            <canvas id="portfolio-chart"></canvas>
        </div>
    </div>

    <!-- Wallet Page -->
    <div id="wallet" class="page">
        <h2>Wallet Management</h2>
        <div>
            <h3>Purchase $KUSD</h3>
            <input id="kusd-amount" type="number" placeholder="Amount to Purchase ($)" min="0" step="0.01" />
            <button onclick="purchaseKUSD()">Purchase $KUSD</button>
            <div id="kusd-msg"></div>
        </div>
        <div>
            <h3>Withdraw $KUSD</h3>
            <input id="withdraw-amount" type="number" placeholder="Amount to Withdraw ($KUSD)" min="0" step="0.01" />
            <button onclick="withdrawKUSD()">Withdraw $KUSD</button>
            <div id="withdraw-msg"></div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profile" class="page">
        <h2>User Profile</h2>
        <div id="user-info"></div>
        <button onclick="openChangePasswordModal()">Change Password</button>
        <button onclick="logout()">Logout</button>
    </div>

    <!-- Settings Page -->
    <div id="settings" class="page">
        <h2>Settings</h2>
        <div>
            <label>Theme:</label>
            <select id="theme-select">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
            </select>
        </div>
        <div>
            <label>Currency Display:</label>
            <select id="currency-select">
                <option value="KUSD">$KUSD</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
            </select>
        </div>
        <div>
            <label>Notifications:</label>
            <input type="checkbox" id="notifications" />
            <label for="notifications">Enable Price Alerts</label>
        </div>
        <button onclick="saveSettings()">Save Settings</button>
        <div id="settings-msg"></div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal">
        <div class="modal-content">
            <h2>Change Password</h2>
            <input id="old-password" type="password" placeholder="Old Password" />
            <input id="new-password" type="password" placeholder="New Password" />
            <input id="confirm-password" type="password" placeholder="Confirm New Password" />
            <button onclick="changePassword()">Update Password</button>
            <button onclick="closeModal('change-password-modal')">Cancel ❌</button>
            <div id="password-msg"></div>
        </div>
    </div>

    <script>
        // Token data with $KUSD as stablecoin
        const tokens = [
            { symbol: "KING", price: 100, change: 0, volume: 10000, marketCap: 1000000, high24h: 110, low24h: 90, liquidity: 500000, orderBook: { buys: [], sells: [] }, chartData: [] },
            { symbol: "GIVNIX", price: 50, change: 0, volume: 8000, marketCap: 500000, high24h: 55, low24h: 45, liquidity: 300000, orderBook: { buys: [], sells: [] }, chartData: [] },
            { symbol: "BGMI", price: 10, change: 0, volume: 5000, marketCap: 100000, high24h: 12, low24h: 8, liquidity: 100000, orderBook: { buys: [], sells: [] }, chartData: [] },
            { symbol: "PUBG", price: 5, change: 0, volume: 3000, marketCap: 50000, high24h: 6, low24h: 4, liquidity: 50000, orderBook: { buys: [], sells: [] }, chartData: [] },
            { symbol: "CRYPTO", price: 75, change: 0, volume: 6000, marketCap: 750000, high24h: 80, low24h: 70, liquidity: 400000, orderBook: { buys: [], sells: [] }, chartData: [] },
            { symbol: "RISE", price: 25, change: 0, volume: 4000, marketCap: 250000, high24h: 28, low24h: 22, liquidity: 200000, orderBook: { buys: [], sells: [] }, chartData: [] },
            { symbol: "KUSD", price: 1, change: 0, volume: 100000, marketCap: 10000000, high24h: 1, low24h: 1, liquidity: 10000000, orderBook: { buys: [], sells: [] }, chartData: [] }
        ];

        let user = null;
        let priceChart = null;
        let portfolioChart = null;
        let marketChart = null;
        let transactions = [];
        let settings = { theme: 'dark', currency: 'KUSD', notifications: false };
        let currentTimeframe = '1h';
        let currentToken = 'KING';

        // Navigation
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('show'));
            document.getElementById(page).classList.add('show');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${page}`).classList.add('active');
            
            switch(page) {
                case 'dashboard': renderDashboard(); break;
                case 'market': renderMarket(); break;
                case 'trade': renderTrade(); break;
                case 'assets': renderAssets(); break;
                case 'wallet': renderWallet(); break;
                case 'profile': renderProfile(); break;
                case 'settings': renderSettings(); break;
            }
            updateUserStatus();
        }

        // Input Validation
        function validateInput(input, type) {
            if (!input) return false;
            switch(type) {
                case 'username': return /^[a-zA-Z0-9]{3,20}$/.test(input);
                case 'password': return input.length >= 8;
                case 'email': return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input);
                case 'amount': return !isNaN(input) && input > 0;
                default: return true;
            }
        }

        // Show Message
        function showMessage(elementId, type, message) {
            document.getElementById(elementId).innerHTML = `<p class="${type}">${message}</p>`;
            setTimeout(() => document.getElementById(elementId).innerHTML = '', 5000);
        }

        // Update User Status
        function updateUserStatus() {
            document.getElementById('user-status').innerHTML = user ? 
                `Welcome, ${user.username} | $KUSD: ${user.kusdBalance?.toFixed(2) || 0}` : 
                'Please login';
        }

        // Signup
        function signup() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const email = document.getElementById("email").value;

            if (!validateInput(username, 'username')) {
                return showMessage('login-msg', 'error', 'Invalid username (3-20 alphanumeric characters)');
            }
            if (!validateInput(password, 'password')) {
                return showMessage('login-msg', 'error', 'Password must be at least 8 characters');
            }
            if (!validateInput(email, 'email')) {
                return showMessage('login-msg', 'error', 'Invalid email address');
            }

            if (localStorage.getItem(`user-${username}`)) {
                return showMessage('login-msg', 'error', 'Username already exists');
            }

            const newUser = {
                username,
                password,
                email,
                balance: 1000,
                kusdBalance: 1000,
                holdings: {},
                transactions: [],
                createdAt: Date.now()
            };
            localStorage.setItem(`user-${username}`, JSON.stringify(newUser));
            showMessage('login-msg', 'success', 'Signup successful! Please login.');
        }

        // Login
        function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const data = localStorage.getItem(`user-${username}`);

            if (!data) {
                return showMessage('login-msg', 'error', 'No user found');
            }

            const userData = JSON.parse(data);
            if (userData.password !== password) {
                return showMessage('login-msg', 'error', 'Wrong password');
            }

            user = userData;
            transactions = userData.transactions || [];
            localStorage.setItem("current-user", username);
            document.getElementById("login").classList.remove('show');
            showPage('dashboard');
        }

        // Logout
        function logout() {
            user = null;
            transactions = [];
            localStorage.removeItem("current-user");
            document.querySelectorAll('.page').forEach(p => p.classList.remove('show'));
            document.getElementById("login").classList.add('show');
            updateUserStatus();
        }

        // Render Dashboard
        function renderDashboard() {
            let summary = `
                <h3>Portfolio Summary</h3>
                <p><b>Total Value:</b> $${calculatePortfolioValue().toFixed(2)}</p>
                <p><b>$KUSD Balance:</b> $${user.kusdBalance?.toFixed(2) || 0}</p>
            `;
            document.getElementById("portfolio-summary").innerHTML = summary;

            document.getElementById("market-news").innerHTML = `
                <h3>Market News</h3>
                <p>KING token surges 15% after new partnership!</p>
                <p>GIVNIX introduces staking with 10% APY.</p>
                <p>CRYPTO launches new DeFi protocol.</p>
            `;

            updateMarketChart();
        }

        // Calculate Portfolio Value
        function calculatePortfolioValue() {
            let total = user.kusdBalance || 0;
            Object.entries(user.holdings).forEach(([token, quantity]) => {
                const tokenData = tokens.find(t => t.symbol === token);
                if (tokenData) total += quantity * tokenData.price;
            });
            return total;
        }

        // Update Market Chart
        function updateMarketChart() {
            if (!marketChart) {
                marketChart = new Chart(document.getElementById("market-overview-chart"), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 20}, (_, i) => i),
                        datasets: tokens.filter(t => t.symbol !== 'KUSD').map(token => ({
                            label: token.symbol,
                            data: Array.from({length: 20}, () => token.price + (Math.random() - 0.5) * 10),
                            borderColor: getRandomColor(),
                            tension: 0.4,
                            fill: false
                        }))
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: false, grid: { borderColor: '#444' }, ticks: { color: '#fff' } },
                            x: { grid: { borderColor: '#444' }, ticks: { color: '#fff' } }
                        },
                        plugins: { legend: { labels: { color: '#fff' } } }
                    }
                });
            } else {
                marketChart.data.datasets.forEach(dataset => {
                    dataset.data.shift();
                    const token = tokens.find(t => t.symbol === dataset.label);
                    dataset.data.push(token.price + (Math.random() - 0.5) * 10);
                });
                marketChart.update();
            }
        }

        // Get Random Color
        function getRandomColor() {
            const colors = ['#00ff88', '#00c4ff', '#ff4d4d', '#ffeb3b', '#e91e63', '#4caf50'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Render Market
        function renderMarket() {
            let html = '';
            tokens.filter(t => t.symbol !== 'KUSD').forEach(token => {
                const changeClass = token.change >= 0 ? 'success' : 'error';
                html += `
                    <div class="token-card" onclick="selectToken('${token.symbol}')">
                        <div>
                            <b>${token.symbol}/KUSD</b>
                            <p>$${token.price.toFixed(2)}</p>
                        </div>
                        <div>
                            <span class="${changeClass}">${token.change.toFixed(2)}%</span>
                        </div>
                        <div>
                            <p>Vol: ${token.volume.toLocaleString()}</p>
                        </div>
                        <div>
                            <p>24h High: $${token.high24h.toFixed(2)}</p>
                            <p>24h Low: $${token.low24h.toFixed(2)}</p>
                        </div>
                        <div>
                            <p>Liquidity: $${token.liquidity.toLocaleString()}</p>
                        </div>
                    </div>`;
            });
            document.getElementById("token-list").innerHTML = html;
        }

        // Select Token
        function selectToken(symbol) {
            currentToken = symbol;
            showPage('trade');
        }

        // Render Trade
        function renderTrade() {
            // Render token navigation
            let tokenNav = '';
            tokens.filter(t => t.symbol !== 'KUSD').forEach(token => {
                tokenNav += `<button onclick="selectToken('${token.symbol}')" class="${currentToken === token.symbol ? 'active' : ''}">${token.symbol}/KUSD</button>`;
            });
            document.getElementById("token-list-nav").innerHTML = tokenNav;

            // Render market stats
            const token = tokens.find(t => t.symbol === currentToken);
            document.getElementById("market-stats").innerHTML = `
                <div><p><b>Price:</b> $${token.price.toFixed(2)}</p></div>
                <div><p><b>24h Change:</b> <span class="${token.change >= 0 ? 'success' : 'error'}">${token.change.toFixed(2)}%</span></p></div>
                <div><p><b>24h High/Low:</b> $${token.high24h.toFixed(2)} / $${token.low24h.toFixed(2)}</p></div>
                <div><p><b>Liquidity:</b> $${token.liquidity.toLocaleString()}</p></div>
            `;

            updatePriceChart();
            renderOrderBook();
            renderTransactionHistory();
            updateTimeframeButtons();
        }

        // Set Timeframe
        function setTimeframe(tf) {
            currentTimeframe = tf;
            updateTimeframeButtons();
            updatePriceChart();
        }

        // Update Timeframe Buttons
        function updateTimeframeButtons() {
            document.querySelectorAll('.timeframe-selector button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === `tf-${currentTimeframe}`) btn.classList.add('active');
            });
        }

        // Update Price Chart
        function updatePriceChart() {
            const token = tokens.find(t => t.symbol === currentToken);
            
            if (!token.chartData.length) {
                token.chartData = Array.from({length: 20}, () => ({
                    t: Date.now(),
                    o: token.price + (Math.random() - 0.5) * 5,
                    h: token.price + Math.random() * 10,
                    l: token.price - Math.random() * 10,
                    c: token.price + (Math.random() - 0.5) * 5
                }));
            }

            if (priceChart) {
                priceChart.destroy();
            }

            priceChart = new Chart(document.getElementById("price-chart"), {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: `${currentToken}/KUSD`,
                        data: token.chartData
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { type: 'time', time: { unit: timeframeUnit() }, ticks: { color: '#fff' } },
                        y: { beginAtZero: false, ticks: { color: '#fff' }, grid: { borderColor: '#444' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
        }

        // Timeframe Unit
        function timeframeUnit() {
            switch(currentTimeframe) {
                case '1m': return 'minute';
                case '5m': return 'minute';
                case '15m': return 'minute';
                case '1h': return 'hour';
                default: return 'hour';
            }
        }

        // Render Order Book
        function renderOrderBook() {
            const token = tokens.find(t => t.symbol === currentToken);
            
            // Simulate order book
            token.orderBook.buys = Array.from({length: 8}, () => ({
                price: token.price - Math.random() * 3,
                quantity: Math.random() * 100
            })).sort((a, b) => b.price - a.price);
            
            token.orderBook.sells = Array.from({length: 8}, () => ({
                price: token.price + Math.random() * 3,
                quantity: Math.random() * 100
            })).sort((a, b) => a.price - b.price);

            let buyHtml = '<tr><th>Price ($KUSD)</th><th>Quantity</th></tr>';
            token.orderBook.buys.forEach(order => {
                buyHtml += `<tr class="buy"><td>${order.price.toFixed(2)}</td><td>${order.quantity.toFixed(4)}</td></tr>`;
            });

            let sellHtml = '<tr><th>Price ($KUSD)</th><th>Quantity</th></tr>';
            token.orderBook.sells.forEach(order => {
                sellHtml += `<tr class="sell"><td>${order.price.toFixed(2)}</td><td>${order.quantity.toFixed(4)}</td></tr>`;
            });

            document.getElementById("buy-orders").innerHTML = buyHtml;
            document.getElementById("sell-orders").innerHTML = sellHtml;
        }

        // Render Transaction History
        function renderTransactionHistory() {
            let html = '<h3>Transaction History</h3>';
            transactions.forEach(t => {
                html += `
                    <div class="transaction-item">
                        <p><b>${t.type}</b> ${t.token}/KUSD: ${t.quantity.toFixed(4)} @ $${t.price.toFixed(2)}</p>
                        <p>${new Date(t.timestamp).toLocaleString()}</p>
                    </div>`;
            });
            document.getElementById("transaction-history").innerHTML = html;
        }

        // Buy Token
        function buyToken() {
            if (!user) return showMessage('trade-msg', 'error', 'Please login first');

            const amount = parseFloat(document.getElementById("buy-amount").value);
            const tradeType = document.getElementById("buy-type").value;
            const limitPrice = parseFloat(document.getElementById("buy-limit-price").value) || null;
            const token = tokens.find(t => t.symbol === currentToken);

            if (!validateInput(amount, 'amount')) {
                return showMessage('trade-msg', 'error', 'Invalid amount');
            }

            if (tradeType === 'limit' && !limitPrice) {
                return showMessage('trade-msg', 'error', 'Limit price required for limit order');
            }

            if (amount > user.kusdBalance) {
                return showMessage('trade-msg', 'error', 'Insufficient $KUSD balance');
            }

            const price = tradeType === 'limit' ? limitPrice : token.price;
            const quantity = amount / price;

            user.kusdBalance -= amount;
            user.holdings[currentToken] = (user.holdings[currentToken] || 0) + quantity;
            
            transactions.push({
                type: 'Buy',
                token: currentToken,
                quantity,
                price,
                timestamp: Date.now()
            });

            token.orderBook.buys.push({ price, quantity });
            token.orderBook.buys.sort((a, b) => b.price - a.price);

            saveUser();
            showMessage('trade-msg', 'success', `Bought ${quantity.toFixed(4)} ${currentToken} for ${amount.toFixed(2)} $KUSD`);
            renderTrade();
            renderAssets();
        }

        // Sell Token
        function sellToken() {
            if (!user) return showMessage('trade-msg', 'error', 'Please login first');

            const amount = parseFloat(document.getElementById("sell-amount").value);
            const tradeType = document.getElementById("sell-type").value;
            const limitPrice = parseFloat(document.getElementById("sell-limit-price").value) || null;
            const token = tokens.find(t => t.symbol === currentToken);

            if (!validateInput(amount, 'amount')) {
                return showMessage('trade-msg', 'error', 'Invalid amount');
            }

            const price = tradeType === 'limit' ? limitPrice : token.price;
            const quantity = amount / price;

            if (!user.holdings[currentToken] || user.holdings[currentToken] < quantity) {
                return showMessage('trade-msg', 'error', 'Insufficient holdings');
            }

            user.holdings[currentToken] -= quantity;
            user.kusdBalance += amount;
            
            transactions.push({
                type: 'Sell',
                token: currentToken,
                quantity,
                price,
                timestamp: Date.now()
            });

            token.orderBook.sells.push({ price, quantity });
            token.orderBook.sells.sort((a, b) => a.price - b.price);

            saveUser();
            showMessage('trade-msg', 'success', `Sold ${quantity.toFixed(4)} ${currentToken} for ${amount.toFixed(2)} $KUSD`);
            renderTrade();
            renderAssets();
        }

        // Purchase $KUSD
        function purchaseKUSD() {
            if (!user) return showMessage('kusd-msg', 'error', 'Please login first');

            const amount = parseFloat(document.getElementById("kusd-amount").value);
            if (!validateInput(amount, 'amount')) {
                return showMessage('kusd-msg', 'error', 'Invalid amount');
            }

            if (amount > user.balance) {
                return showMessage('kusd-msg', 'error', 'Insufficient balance');
            }

            user.balance -= amount;
            user.kusdBalance = (user.kusdBalance || 0) + amount;
            saveUser();
            showMessage('kusd-msg', 'success', `Purchased ${amount.toFixed(2)} $KUSD`);
            renderWallet();
            updateUserStatus();
        }

        // Withdraw $KUSD
        function withdrawKUSD() {
            if (!user) return showMessage('withdraw-msg', 'error', 'Please login first');

            const amount = parseFloat(document.getElementById("withdraw-amount").value);
            if (!validateInput(amount, 'amount')) {
                return showMessage('withdraw-msg', 'error', 'Invalid amount');
            }

            if (amount > user.kusdBalance) {
                return showMessage('withdraw-msg', 'error', 'Insufficient $KUSD balance');
            }

            user.kusdBalance -= amount;
            user.balance += amount;
            saveUser();
            showMessage('withdraw-msg', 'success', `Withdrew ${amount.toFixed(2)} $KUSD`);
            renderWallet();
            updateUserStatus();
        }

        // Save User
        function saveUser() {
            user.transactions = transactions;
            localStorage.setItem(`user-${user.username}`, JSON.stringify(user));
        }

        // Render Assets
        function renderAssets() {
            if (!user) return;

            document.getElementById("balance").innerHTML = `<p><b>USD Balance:</b> $${user.balance.toFixed(2)}</p>`;
            document.getElementById("kusd-balance").innerHTML = `<p><b>$KUSD Balance:</b> $${user.kusdBalance?.toFixed(2) || 0}</p>`;
            document.getElementById("portfolio-value").innerHTML = `<p><b>Total Portfolio Value:</b> $${calculatePortfolioValue().toFixed(2)}</p>`;

            let html = '<h3>Holdings</h3>';
            for (let [token, quantity] of Object.entries(user.holdings)) {
                const tokenData = tokens.find(t => t.symbol === token);
                const value = quantity * tokenData.price;
                html += `
                    <div class="token-card">
                        <p><b>${token}/KUSD</b></p>
                        <p>${quantity.toFixed(4)}</p>
                        <p>Value: $${value.toFixed(2)}</p>
                        <p>Price: $${tokenData.price.toFixed(2)}</p>
                        <p>24h: <span class="${tokenData.change >= 0 ? 'success' : 'error'}">${tokenData.change.toFixed(2)}%</span></p>
                    </div>`;
            }
            document.getElementById("holdings").innerHTML = html;

            updatePortfolioChart();
        }

        // Update Portfolio Chart
        function updatePortfolioChart() {
            const data = Object.entries(user.holdings).map(([token, quantity]) => {
                const tokenData = tokens.find(t => t.symbol === token);
                return quantity * tokenData.price;
            });

            if (!portfolioChart) {
                portfolioChart = new Chart(document.getElementById("portfolio-chart"), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(user.holdings),
                        datasets: [{
                            data,
                            backgroundColor: ['#00ff88', '#00c4ff', '#ff4d4d', '#ffeb3b', '#e91e63', '#4caf50']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { labels: { color: '#fff' } } }
                    }
                });
            } else {
                portfolioChart.data.datasets[0].data = data;
                portfolioChart.update();
            }
        }

        // Render Wallet
        function renderWallet() {
            document.getElementById("kusd-balance").innerHTML = `<p><b>$KUSD Balance:</b> $${user.kusdBalance?.toFixed(2) || 0}</p>`;
        }

        // Render Profile
        function renderProfile() {
            if (!user) return;
            document.getElementById("user-info").innerHTML = `
                <p><b>Username:</b> ${user.username}</p>
                <p><b>Email:</b> ${user.email}</p>
                <p><b>Account Created:</b> ${new Date(user.createdAt).toLocaleDateString()}</p>
                <p><b>Total Trades:</b> ${transactions.length}</p>
            `;
        }

        // Render Settings
        function renderSettings() {
            document.getElementById("theme-select").value = settings.theme;
            document.getElementById("currency-select").value = settings.currency;
            document.getElementById("notifications").checked = settings.notifications;
        }

        // Save Settings
        function saveSettings() {
            settings.theme = document.getElementById("theme-select").value;
            settings.currency = document.getElementById("currency-select").value;
            settings.notifications = document.getElementById("notifications").checked;
            applySettings();
            showMessage('settings-msg', 'success', 'Settings saved');
        }

        // Apply Settings
        function applySettings() {
            if (settings.theme === 'light') {
                document.body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)';
                document.querySelectorAll('.page, .token-card, .buy-sell, .modal-content, .order-book, .token-list').forEach(el => {
                    el.style.background = '#ffffff';
                    el.style.color = '#000000';
                });
            } else {
                document.body.style.background = 'linear-gradient(135deg, #0a0e17 0%, #1a2332 100%)';
                document.querySelectorAll('.page, .token-card, .buy-sell, .modal-content, .order-book, .token-list').forEach(el => {
                    el.style.background = '#1f2a44';
                    el.style.color = '#ffffff';
                });
            }
        }

        // Change Password
        function changePassword() {
            const oldPassword = document.getElementById("old-password").value;
            const newPassword = document.getElementById("new-password").value;
            const confirmPassword = document.getElementById("confirm-password").value;

            if (!validateInput(newPassword, 'password')) {
                return showMessage('password-msg', 'error', 'New password must be at least 8 characters');
            }

            if (newPassword !== confirmPassword) {
                return showMessage('password-msg', 'error', 'Passwords do not match');
            }

            if (oldPassword !== user.password) {
                return showMessage('password-msg', 'error', 'Incorrect old password');
            }

            user.password = newPassword;
            saveUser();
            showMessage('password-msg', 'success', 'Password updated successfully');
            closeModal('change-password-modal');
        }

        // Modal Controls
        function openChangePasswordModal() {
            document.getElementById("change-password-modal").style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Market Simulation (Per-Second Update)
        setInterval(() => {
            tokens.forEach(token => {
                if (token.symbol === 'KUSD') return; // Stablecoin price remains $1
                const change = (Math.random() - 0.5) * 5;
                token.price = Math.max(0.1, token.price + change);
                token.change = ((token.price - 100) / 100 * 100).toFixed(2);
                token.volume = Math.max(1000, token.volume + (Math.random() - 0.5) * 1000);
                token.marketCap = token.price * 10000;
                token.high24h = Math.max(token.high24h, token.price);
                token.low24h = Math.min(token.low24h, token.price);
                
                // Update chart data
                token.chartData.shift();
                token.chartData.push({
                    t: Date.now(),
                    o: token.price + (Math.random() - 0.5) * 5,
                    h: token.price + Math.random() * 10,
                    l: token.price - Math.random() * 10,
                    c: token.price + (Math.random() - 0.5) * 5
                });
            });

            if (document.getElementById('market').classList.contains('show')) {
                renderMarket();
            }
            if (document.getElementById('trade').classList.contains('show')) {
                renderTrade();
            }
            if (document.getElementById('assets').classList.contains('show')) {
                renderAssets();
            }
            if (document.getElementById('dashboard').classList.contains('show')) {
                renderDashboard();
            }
        }, 1000); // Update every second

        // Auto Login
        window.onload = () => {
            const currentUser = localStorage.getItem("current-user");
            if (currentUser) {
                user = JSON.parse(localStorage.getItem(`user-${currentUser}`));
                transactions = user.transactions || [];
                document.getElementById("login").classList.remove('show');
                showPage('dashboard');
            }
            applySettings();
            updateUserStatus();
        };
    </script>
</body>
</html>
