<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JokeFi Wallet - Kingdom Blockchain</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#f8f1e9;color:#333;display:flex;justify-content:center;align-items:center;min-height:100vh;overflow-x:hidden;}
.wallet-container{background:#fffcf5;padding:2rem;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);width:100%;max-width:650px;text-align:center;position:relative;}
h1{font-size:2rem;margin-bottom:0.5rem;}
.subtitle{font-size:1rem;color:#666;margin-bottom:1.5rem;}
.scanner-btn{position:absolute;top:1rem;right:1rem;background:#d6c6a8;color:#333;border:none;border-radius:50%;padding:0.6rem;cursor:pointer;font-size:1.3rem;}
.lock-btn{position:absolute;top:1rem;left:1rem;background:#d6c6a8;color:#333;border:none;border-radius:50%;padding:0.6rem;cursor:pointer;font-size:1.3rem;}
.balance{font-size:2.5rem;font-weight:bold;margin:1rem 0;color:#2c3e50;}
.buttons{display:flex;justify-content:center;gap:1rem;margin-bottom:1.5rem;}
button{padding:0.8rem 1.5rem;border:none;border-radius:5px;font-size:1rem;cursor:pointer;transition:0.3s;}
.cream-btn{background-color:#d6c6a8;color:#333;}
.cream-btn:hover{background-color:#c9b894;}
.divider{border-top:1px solid #ddd;margin:1.5rem 0;}
.assets,.market{display:flex;flex-direction:column;gap:0.8rem;}
.token{background:#f9f9f9;padding:0.8rem;border-radius:5px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:0.2s;}
.token:hover{transform:scale(1.02);}
.token-price{font-weight:bold;color:#27ae60;}
.token-name{display:flex;align-items:center;gap:0.5rem;}
.popup,.scanner-popup,.confirm-popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:flex-end;z-index:1000;}
.token-popup{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;}
.popup-content,.scanner-popup-content,.confirm-popup-content{background:white;padding:2rem;border-radius:10px 10px 0 0;text-align:center;max-width:400px;width:100%;height:40vh;}
.token-popup-content{background:white;padding:2rem;width:100vw;height:100vh;text-align:center;overflow-y:auto;}
.popup-content p,.scanner-popup-content p{word-break:break-all;margin-bottom:1rem;cursor:pointer;}
.close-btn{background-color:#95a5a6;color:white;padding:0.5rem 1rem;border:none;border-radius:5px;cursor:pointer;}
.close-btn:hover{background-color:#7f8c8d;}
input{margin:0.5rem 0;padding:0.6rem;width:90%;border-radius:5px;border:1px solid #ccc;}
canvas{margin-bottom:1rem;}
#scanner-line{position:absolute;left:0;width:100%;height:3px;background:lime;animation:scan 2s infinite;z-index:10;display:none;}
@keyframes scan{0%{top:0;}50%{top:100%;}100%{top:0;}}
.confirm-buttons{display:flex;justify-content:space-around;margin-top:1rem;}
.kingdom-stamp{position:absolute;top:20%;left:50%;transform:translateX(-50%) rotate(30deg);opacity:0.4;font-size:2rem;font-weight:bold;color:#333;}
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.confirm-popup-content{animation:slideUp 0.3s ease-out;}
.transaction-lists{display:flex;justify-content:space-between;padding:1rem;}
.transaction-column{width:45%;text-align:left;}
.transaction-column h4{margin-bottom:1rem;}
.transaction-item{margin:0.5rem 0;font-size:0.9rem;}
</style>
</head>
<body>
<div class="wallet-container">
<button class="lock-btn" onclick="openClaimFundsPopup()">üîí</button>
<button class="scanner-btn" onclick="openScanner()">üî≤</button>
<h1>JokeFi Wallet</h1>
<div class="subtitle">Kingdom Blockchain Testnet</div>
<div class="balance" id="balance">0 KDM</div>
<div class="buttons">
  <button class="cream-btn" onclick="deposit()">Deposit</button>
  <button class="cream-btn" onclick="receive()">Receive</button>
  <button class="cream-btn" onclick="openSendPopup()">Send</button>
</div>
<div class="divider"></div>
<div class="assets" id="assets">
  <h3>Assets</h3>
</div>
<div class="divider"></div>
<div class="market" id="market">
  <h3>Market</h3>
</div>
</div>

<!-- Deposit Popup -->
<div class="popup" id="deposit-popup">
<div class="popup-content">
<p>If you want KDM funds, contact:</p>
<p><a href="https://x.com/_RetweetGuy?t=y7FQoP9txZmG_lCTCA2U6Q&s=09" target="_blank">KDM Blockchain Sender</a></p>
<p>DM them and you will receive funds.</p>
<button class="close-btn" onclick="closeDepositPopup()">Close</button>
</div>
</div>

<!-- Receive Popup -->
<div class="popup" id="receive-popup">
<div class="popup-content">
<canvas id="qr-code"></canvas>
<p id="wallet-address" onclick="copyAddress()"></p>
<button class="close-btn" onclick="closePopup()">Close</button>
</div>
</div>

<!-- Send Popup -->
<div class="popup" id="send-popup">
<div class="popup-content">
<h3>Send KDM</h3>
<input type="text" id="send-address" placeholder="Recipient Address">
<input type="number" id="send-amount" placeholder="Amount (KDM)">
<button class="cream-btn" onclick="confirmSend()">Send</button>
<br><br>
<button class="close-btn" onclick="closeSendPopup()">Close</button>
</div>
</div>

<!-- Token Details Popup -->
<div class="token-popup" id="token-popup">
<div class="token-popup-content">
<h3 id="token-title"></h3>
<p id="token-price"></p>
<hr class="divider">
<div class="transaction-lists">
<div class="transaction-column">
<h4>Recent Buyers</h4>
<div id="buyers-list"></div>
</div>
<div class="transaction-column">
<h4>Recent Sellers</h4>
<div id="sellers-list"></div>
</div>
</div>
<div class="buttons">
  <button class="cream-btn" onclick="openBuyTokenPopup()">Buy</button>
  <button class="cream-btn" onclick="openSellTokenPopup()">Sell</button>
</div>
<button class="close-btn" onclick="closeTokenPopup()">Close</button>
</div>
</div>

<!-- Buy Token Popup -->
<div class="popup" id="buy-token-popup">
<div class="popup-content">
<h3>Buy <span id="buy-token-name"></span></h3>
<input type="number" id="buy-token-amount" placeholder="Amount to Buy">
<button class="cream-btn" onclick="confirmBuyToken()">Buy</button>
<br><br>
<button class="close-btn" onclick="closeBuyTokenPopup()">Close</button>
</div>
</div>

<!-- Sell Token Popup -->
<div class="popup" id="sell-token-popup">
<div class="popup-content">
<h3>Sell <span id="sell-token-name"></span></h3>
<input type="number" id="sell-token-amount" placeholder="Amount to Sell">
<button class="cream-btn" onclick="confirmSellToken()">Sell</button>
<br><br>
<button class="close-btn" onclick="closeSellTokenPopup()">Close</button>
</div>
</div>

<!-- Claim Funds Popup -->
<div class="popup" id="claim-funds-popup">
<div class="popup-content">
<h3>Claim 1B KDM</h3>
<input type="text" id="claim-address" placeholder="Wallet Address">
<input type="password" id="claim-password" placeholder="Password">
<button class="cream-btn" onclick="claimFunds()">Claim</button>
<br><br>
<button class="close-btn" onclick="closeClaimFundsPopup()">Close</button>
</div>
</div>

<!-- Confirm Transaction Popup -->
<div class="confirm-popup" id="confirm-transaction-popup">
<div class="confirm-popup-content">
<p id="confirm-message"></p>
<div class="confirm-buttons">
<button class="cream-btn" onclick="signTransaction()">Sign</button>
<button class="close-btn" onclick="closeConfirmPopup()">Cancel</button>
</div>
</div>
</div>

<!-- Transaction Success Popup -->
<div class="confirm-popup" id="transaction-success-popup">
<div class="confirm-popup-content">
<div class="kingdom-stamp">KINGDOM</div>
<p id="success-message"></p>
<button class="cream-btn" onclick="completeTransaction()">Confirm</button>
</div>
</div>

<!-- QR Scanner Popup -->
<div class="scanner-popup" id="scanner-popup">
<div class="scanner-popup-content" style="position:relative;">
<div id="scanner-line"></div>
<video id="video" width="300" height="300" style="border:1px solid #ccc;"></video>
<p id="scanner-msg"></p>
<button class="close-btn" onclick="closeScanner()">Close</button>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
// Generate random wallet address
function generateWalletAddress() {
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
  let address = 'kingdom';
  for (let i = 0; i < 34; i++) {
    address += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return address;
}

// Generate partial wallet address for display
function generatePartialAddress() {
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
  let end = '';
  for (let i = 0; i < 5; i++) {
    end += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return `kingdom*****${end}`;
}

// Initialize wallet address
let myAddress = localStorage.getItem('myWalletAddress');
if (!myAddress) {
  myAddress = generateWalletAddress();
  localStorage.setItem('myWalletAddress', myAddress);
}

// Initialize wallets and transactions
let wallets = JSON.parse(localStorage.getItem('wallets') || '{}');
let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
if (!wallets[myAddress]) wallets[myAddress] = 0; // Initialize with 0, claim funds to get 1B
localStorage.setItem('wallets', JSON.stringify(wallets));

// Token holdings (all set to 0 initially)
let tokenHoldings = JSON.parse(localStorage.getItem('tokenHoldings') || '{}');
if (!tokenHoldings[myAddress]) tokenHoldings[myAddress] = {};
tokens.forEach(t => {
  if (!tokenHoldings[myAddress][t.name]) tokenHoldings[myAddress][t.name] = 0;
});
localStorage.setItem('tokenHoldings', JSON.stringify(tokenHoldings));

// Tokens
let tokens = [
  {emoji:'ü™ô',name:'GoldCoin',price:1},
  {emoji:'üíé',name:'Diamond',price:2},
  {emoji:'üöÄ',name:'Rocket',price:3},
  {emoji:'üê∂',name:'Doge',price:0.5},
  {emoji:'üçå',name:'Banana',price:0.8},
  {emoji:'üî•',name:'Fire',price:4},
  {emoji:'üåï',name:'Moon',price:2},
  {emoji:'üê±',name:'CatToken',price:1.5},
  {emoji:'üéÆ',name:'Gamer',price:0.7},
  {emoji:'üèÜ',name:'Trophy',price:1.2},
  {emoji:'‚ö°',name:'Thunder',price:3.5},
  {emoji:'üçï',name:'Pizza',price:2.5},
  {emoji:'üêâ',name:'Dragon',price:4.5},
  {emoji:'üßä',name:'Ice',price:1.8},
  {emoji:'üéµ',name:'Music',price:2}
];

// Initialize wallet
function initWallet() {
  updateBalance();
  displayAssets();
  displayMarket();
  setInterval(updateTokenPrices, 5000);
}

// Balance
function updateBalance() {
  wallets = JSON.parse(localStorage.getItem('wallets') || '{}');
  document.getElementById('balance').textContent = (wallets[myAddress] || 0).toFixed(2) + ' KDM';
  displayAssets();
}

// Display assets
function displayAssets() {
  const assetsDiv = document.getElementById('assets');
  assetsDiv.innerHTML = '<h3>Assets</h3>';
  wallets = JSON.parse(localStorage.getItem('wallets') || '{}');
  tokenHoldings = JSON.parse(localStorage.getItem('tokenHoldings') || '{}');
  const kdmBalance = wallets[myAddress] || 0;
  const div = document.createElement('div');
  div.className = 'token';
  div.innerHTML = `<span class="token-name">üíµ KDM</span><span class="token-price">${kdmBalance.toFixed(2)} KDM</span>`;
  assetsDiv.appendChild(div);
  Object.keys(tokenHoldings[myAddress]).forEach(token => {
    const amount = tokenHoldings[myAddress][token];
    if (amount > 0) {
      const tokenData = tokens.find(t => t.name === token);
      if (tokenData) {
        const div = document.createElement('div');
        div.className = 'token';
        div.innerHTML = `<span class="token-name">${tokenData.emoji} ${token}</span><span class="token-price">${amount.toFixed(2)} ${token}</span>`;
        assetsDiv.appendChild(div);
      }
    }
  });
}

// Display market
function displayMarket() {
  const marketDiv = document.getElementById('market');
  marketDiv.innerHTML = '<h3>Market</h3>';
  tokens.forEach(t => {
    const div = document.createElement('div');
    div.className = 'token';
    div.onclick = () => showTokenDetails(t);
    div.innerHTML = `<span class="token-name">${t.emoji} ${t.name}</span><span class="token-price">$${t.price}</span>`;
    marketDiv.appendChild(div);
  });
}

// Update token prices
function updateTokenPrices() {
  tokens.forEach(t => t.price = (Math.random() * (5 - 0.01) + 0.01).toFixed(2));
  displayMarket();
  if (document.getElementById('token-popup').style.display === 'flex' && currentToken) {
    document.getElementById('token-price').textContent = `Price: $${currentToken.price}`;
  }
}

// Claim Funds
function openClaimFundsPopup() { document.getElementById('claim-funds-popup').style.display = 'flex'; }
function closeClaimFundsPopup() { document.getElementById('claim-funds-popup').style.display = 'none'; }
function claimFunds() {
  const address = document.getElementById('claim-address').value.trim();
  const password = document.getElementById('claim-password').value;
  if (!address || !address.startsWith('kingdom')) { alert('Enter a valid Kingdom wallet address!'); return; }
  if (password !== 'TOFIK MUGHAL') { alert('Incorrect password!'); return; }
  wallets = JSON.parse(localStorage.getItem('wallets') || '{}');
  if (!wallets[address]) wallets[address] = 0;
  wallets[address] += 1000000000; // 1 Billion KDM
  localStorage.setItem('wallets', JSON.stringify(wallets));
  transactions.push({ type: 'claim', address: address, amount: 1000000000, timestamp: Date.now() });
  localStorage.setItem('transactions', JSON.stringify(transactions));
  updateBalance();
  alert('1 Billion KDM claimed successfully!');
  closeClaimFundsPopup();
}

// Deposit
function deposit() { document.getElementById('deposit-popup').style.display = 'flex'; }
function closeDepositPopup() { document.getElementById('deposit-popup').style.display = 'none'; }

// Receive
function receive() {
  const popup = document.getElementById('receive-popup');
  document.getElementById('wallet-address').textContent = myAddress;
  QRCode.toCanvas(document.getElementById('qr-code'), myAddress, function (err) { if (err) console.error(err); });
  popup.style.display = 'flex';
}
function copyAddress() { navigator.clipboard.writeText(myAddress); alert('Address copied!'); }
function closePopup() { document.getElementById('receive-popup').style.display = 'none'; }

// Send
function openSendPopup() { document.getElementById('send-popup').style.display = 'flex'; }
function closeSendPopup() { document.getElementById('send-popup').style.display = 'none'; }
function confirmSend() {
  const addr = document.getElementById('send-address').value.trim();
  const amt = parseFloat(document.getElementById('send-amount').value);
  if (!addr || amt <= 0 || isNaN(amt)) { alert('Enter valid address and amount!'); return; }
  if (!addr.startsWith('kingdom')) { alert('Invalid wallet address! Must start with "kingdom".'); return; }
  showConfirmPopup(`Do you want to send ${amt} KDM to ${addr}?`, () => send(addr, amt));
}
function send(addr, amt) {
  wallets = JSON.parse(localStorage.getItem('wallets') || '{}');
  if (!wallets[addr]) wallets[addr] = 0;
  if (wallets[myAddress] < amt) { alert('Insufficient balance!'); return; }
  wallets[myAddress] -= amt;
  wallets[addr] += amt;
  localStorage.setItem('wallets', JSON.stringify(wallets));
  console.log(`Sent ${amt} KDM from ${myAddress} to ${addr}`);
  console.log('Updated wallets:', JSON.parse(JSON.stringify(wallets)));
  transactions.push({ type: 'send', from: myAddress, to: addr, amount: amt, timestamp: Date.now() });
  localStorage.setItem('transactions', JSON.stringify(transactions));
  updateBalance();
  showSuccessPopup(`Transaction of ${amt} KDM to ${addr} completed on Kingdom Blockchain.`);
}

// Token Details
let currentToken;
function showTokenDetails(t) {
  currentToken = t;
  document.getElementById('token-title').textContent = `${t.emoji} ${t.name}`;
  document.getElementById('token-price').textContent = `Price: $${t.price}`;
  const buyersList = document.getElementById('buyers-list');
  const sellersList = document.getElementById('sellers-list');
  buyersList.innerHTML = '';
  sellersList.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const buyAmount = (Math.random() * 100 + 1).toFixed(2);
    const sellAmount = (Math.random() * 100 + 1).toFixed(2);
    const buyAddress = generatePartialAddress();
    const sellAddress = generatePartialAddress();
    buyersList.innerHTML += `<div class="transaction-item">${buyAddress} bought ${buyAmount} ${t.name}</div>`;
    sellersList.innerHTML += `<div class="transaction-item">${sellAddress} sold ${sellAmount} ${t.name}</div>`;
  }
  document.getElementById('token-popup').style.display = 'flex';
}
function closeTokenPopup() { document.getElementById('token-popup').style.display = 'none'; }

// Buy Token
function openBuyTokenPopup() {
  document.getElementById('buy-token-name').textContent = currentToken.name;
  document.getElementById('buy-token-popup').style.display = 'flex';
}
function closeBuyTokenPopup() { document.getElementById('buy-token-popup').style.display = 'none'; }
function confirmBuyToken() {
  const amount = parseFloat(document.getElementById('buy-token-amount').value);
  if (isNaN(amount) || amount <= 0) { alert('Enter valid amount!'); return; }
  const cost = amount * currentToken.price; // 1 KDM = 1 USD
  showConfirmPopup(`Do you want to buy ${amount} ${currentToken.name} for ${cost} KDM?`, () => buyToken(amount));
}
function buyToken(amount) {
  const cost = amount * currentToken.price;
  wallets = JSON.parse(localStorage.getItem('wallets') || '{}');
  if (wallets[myAddress] < cost) { alert('Insufficient balance!'); return; }
  wallets[myAddress] -= cost;
  tokenHoldings = JSON.parse(localStorage.getItem('tokenHoldings') || '{}');
  if (!tokenHoldings[myAddress][currentToken.name]) tokenHoldings[myAddress][currentToken.name] = 0;
  tokenHoldings[myAddress][currentToken.name] += amount;
  localStorage.setItem('wallets', JSON.stringify(wallets));
  localStorage.setItem('tokenHoldings', JSON.stringify(tokenHoldings));
  transactions.push({ type: 'buy', token: currentToken.name, amount: amount, cost: cost, timestamp: Date.now() });
  localStorage.setItem('transactions', JSON.stringify(transactions));
  updateBalance();
  showSuccessPopup(`Purchase of ${amount} ${currentToken.name} for ${cost} KDM completed on Kingdom Blockchain.`);
  closeBuyTokenPopup();
}

// Sell Token
function openSellTokenPopup() {
  document.getElementById('sell-token-name').textContent = currentToken.name;
  document.getElementById('sell-token-popup').style.display = 'flex';
}
function closeSellTokenPopup() { document.getElementById('sell-token-popup').style.display = 'none'; }
function confirmSellToken() {
  const amount = parseFloat(document.getElementById('sell-token-amount').value);
  if (isNaN(amount) || amount <= 0) { alert('Enter valid amount!'); return; }
  tokenHoldings = JSON.parse(localStorage.getItem('tokenHoldings') || '{}');
  if (!tokenHoldings[myAddress][currentToken.name] || tokenHoldings[myAddress][currentToken.name] < amount) { alert('Insufficient token balance!'); return; }
  showConfirmPopup(`Do you want to sell ${amount} ${currentToken.name} for ${amount * currentToken.price} KDM?`, () => sellToken(amount));
}
function sellToken(amount) {
  const revenue = amount * currentToken.price; // 1 KDM = 1 USD
  wallets = JSON.parse(localStorage.getItem('wallets') || '{}');
  tokenHoldings = JSON.parse(localStorage.getItem('tokenHoldings') || '{}');
  tokenHoldings[myAddress][currentToken.name] -= amount;
  wallets[myAddress] += revenue;
  localStorage.setItem('wallets', JSON.stringify(wallets));
  localStorage.setItem('tokenHoldings', JSON.stringify(tokenHoldings));
  transactions.push({ type: 'sell', token: currentToken.name, amount: amount, revenue: revenue, timestamp: Date.now() });
  localStorage.setItem('transactions', JSON.stringify(transactions));
  updateBalance();
  showSuccessPopup(`Sale of ${amount} ${currentToken.name} for ${revenue} KDM completed on Kingdom Blockchain.`);
  closeSellTokenPopup();
}

// Confirm and Success Popups
function showConfirmPopup(message, callback) {
  document.getElementById('confirm-message').textContent = message;
  document.getElementById('confirm-transaction-popup').style.display = 'flex';
  window.currentCallback = callback;
}
function closeConfirmPopup() { document.getElementById('confirm-transaction-popup').style.display = 'none'; }
function signTransaction() {
  closeConfirmPopup();
  window.currentCallback();
}
function showSuccessPopup(message) {
  document.getElementById('success-message').textContent = `${message}\nKingdom Blockchain ensures secure and transparent transactions.`;
  document.getElementById('transaction-success-popup').style.display = 'flex';
}
function completeTransaction() {
  document.getElementById('transaction-success-popup').style.display = 'none';
  closeTokenPopup();
  closeSendPopup();
}

// Scanner
let videoStream;
function openScanner() {
  const popup = document.getElementById('scanner-popup');
  popup.style.display = 'flex';
  const video = document.getElementById('video');
  document.getElementById('scanner-line').style.display = 'block';
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      videoStream = stream;
      video.srcObject = stream;
      video.setAttribute('playsinline', true);
      video.play();
      console.log('Camera started successfully');
      requestAnimationFrame(tick);
    })
    .catch(err => {
      console.error('Camera access error:', err);
      document.getElementById('scanner-msg').textContent = 'Camera access denied. Please allow camera permissions.';
    });
}
function closeScanner() {
  document.getElementById('scanner-popup').style.display = 'none';
  document.getElementById('scanner-line').style.display = 'none';
  if (videoStream) {
    videoStream.getTracks().forEach(t => t.stop());
    videoStream = null;
  }
}
function tick() {
  const video = document.getElementById('video');
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if (code) {
      console.log('QR code detected:', code.data);
      processScan(code.data);
      return;
    }
  }
  requestAnimationFrame(tick);
}
function processScan(data) {
  if (data && data.startsWith('kingdom')) {
    let amt = prompt(`Send how much KDM to ${data}?`);
    amt = parseFloat(amt);
    if (isNaN(amt) || amt <= 0) { alert('Invalid amount'); return; }
    showConfirmPopup(`Do you want to send ${amt} KDM to ${data}?`, () => {
      wallets = JSON.parse(localStorage.getItem('wallets') || '{}');
      if (!wallets[data]) wallets[data] = 0;
      if (wallets[myAddress] < amt) { alert('Insufficient balance!'); return; }
      wallets[myAddress] -= amt;
      wallets[data] += amt;
      localStorage.setItem('wallets', JSON.stringify(wallets));
      console.log(`Sent ${amt} KDM from ${myAddress} to ${data}`);
      console.log('Updated wallets:', JSON.parse(JSON.stringify(wallets)));
      transactions.push({ type: 'send', from: myAddress, to: data, amount: amt, timestamp: Date.now() });
      localStorage.setItem('transactions', JSON.stringify(transactions));
      updateBalance();
      showSuccessPopup(`Transaction of ${amt} KDM to ${data} completed on Kingdom Blockchain.`);
    });
  } else {
    alert('Invalid QR code! Must be a Kingdom wallet address.');
  }
  closeScanner();
}

window.onload = initWallet;
</script>
</body>
</html>
